#!/usr/bin/env node

var chalk = require('chalk');
var exists = require('fs').existsSync;
var format = require('util').format;
var indent = require('indent');
var Hermes = require('..');
var program = require('commander');
var resolve = require('path').resolve;
var shell = require('../lib/shell');

/**
 * Program.
 */

program
  .version(require('../package.json').version)
  .option('-s, --shell', 'run the hermes shell for easy debugging', false)
  .usage('[debug]');

program._name = 'hermes';

program.parse(process.argv);

/**
 * Padding.
 */

console.log();
process.on('exit', function(){ console.log(); });

/**
 * Config.
 */

var debug = !! ~program.args.indexOf('debug') || program.shell;
var config = resolve('hermes.json');
if (!exists(config)) fatal('Could not find configuration file at %s', config);

try {
  var json = require(config);
  var name = json.name;
  var template = json.template;
  var plugins = json.plugins || {};
} catch (e) {
  fatal(e);
}

/**
 * Hermes.
 */

var hermes = Hermes();
if (json.name) hermes.name(json.name);
if (json.nickname) hermes.nickname(json.nickname);
if (json.template) hermes.template(json.template);

/**
 * Plugins.
 */

Object.keys(plugins).forEach(function(name){
  try {
    var options = plugins[name];
    var fn = require(resolve(name));
    hermes.use(fn(options));
  } catch (e) {
    fatal(e);
  }
});

/**
 * Debugging.
 */

if (debug) hermes.use(shell());

/**
 * Not debugging.
 */

if (!debug) {
  log('running...');
  process.on('exit', function(){
    log('stopped.');
    console.log();
  });
}

/**
 * Log a formatted `msg`.
 *
 * @param {String} msg
 * @param {Mixed} args...
 */

function log(msg){
  msg = format.apply(null, arguments);
  console.log(chalk.italic.white('   Hermes'), chalk.gray('·'), msg);
}

/**
 * Log a fatal, formatted error `msg` and exit.
 *
 * @param {String or Error} msg
 * @param {Mixed} args...
 */

function fatal(msg){
  if (msg instanceof Error) msg = msg.message + '\n\n' + indent(msg.stack, 12);
  msg = format.apply(null, arguments);
  console.error(chalk.italic.red('   Hermes'), chalk.gray('·'), msg);
  process.exit(1);
}