#!/usr/bin/env node

var exists = require('fs').existsSync;
var Hermes = require('..');
var program = require('commander');
var resolve = require('path').resolve;
var shell = require('../lib/shell');

/**
 * Program.
 */

program
  .version(require('../package.json').version)
  .usage('[debug]');

program.name = 'hermes';

program.parse(process.argv);

/**
 * Config.
 */

var debug = !! ~program.args.indexOf('debug');
var config = resolve('hermes.json');
if (!exists(config)) fatal('Could not find configuration file at %s', config);

try {
  var json = require(config);
  var name = json.name;
  var template = json.template;
  var plugins = json.plugins || {};
} catch (e) {
  fatal(e);
}

/**
 * Hermes.
 */

var hermes = Hermes();
if (json.name) hermes.name(json.name);
if (json.nickname) hermes.nickname(json.nickname);
if (json.template) hermes.template(json.template);

/**
 * Plugins.
 */

Object.keys(plugins).forEach(function(name){
  try {
    var options = plugins[name];
    var fn = require(resolve(name));
    hermes.use(fn(options));
  } catch (e) {
    fatal(e);
  }
});

/**
 * Debugging.
 */

if (debug) hermes.use(shell());

/**
 * Log a fatal `err` and exit.
 *
 * @param {String or Error} err
 * @param {Mixed} args...
 */

function fatal(err){
  if (err instanceof Error) err = err.message + '\n' + err.stack;
  console.error.apply(null, arguments);
  process.exit(1);
}